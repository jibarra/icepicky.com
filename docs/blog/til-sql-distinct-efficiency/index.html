<!doctype html><html lang=en-US><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>Jose Ibarra &#183; TIL: SQL DISTINCT Efficiency</title>
<meta name=description content="I'm a staff software engineer at Bonusly and MCS and BS Computer Science graduate from Arizona State University. I previously worked at Gusto, General Motors, and Sandia National Labs."><meta property="og:description" content="I'm a staff software engineer at Bonusly and MCS and BS Computer Science graduate from Arizona State University. I previously worked at Gusto, General Motors, and Sandia National Labs."><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=referrer content="always"><meta name=googlebot content="index,follow,snippet,archive"><link rel=stylesheet href=//www.icepicky.com/hugo-theme-console/css/terminal-0.7.4.min.css><link rel=stylesheet href=//www.icepicky.com/hugo-theme-console/css/console.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><meta property="og:title" content="TIL: SQL DISTINCT Efficiency"><meta property="og:description" content="I'm a staff software engineer at Bonusly and MCS and BS Computer Science graduate from Arizona State University. I previously worked at Gusto, General Motors, and Sandia National Labs."><meta property="og:type" content="article"><meta property="og:url" content="//www.icepicky.com/blog/til-sql-distinct-efficiency/"><meta property="article:published_time" content="2023-11-07T16:35:46-07:00"><meta name=twitter:title content="TIL: SQL DISTINCT Efficiency"><meta name=twitter:description content="Today I learned that DISTINCT statements can cause efficiency problems.
I was looking at some code that made a few joins across tables and used distinct for the column names. The query was causing high CPU load and it wasn&rsquo;t immediately obvious from first glance why that was happening. You could imagine the query looked like this (with a few more joins and selects):
SELECT DISTINCT transactions.date, transactions.total_amount, transaction_items.amount, transaction_items.name
FROM transactions
INNER JOIN transaction_items ON transaction_items.transaction_id = transactions.id
WHERE transactions.date BETWEEN '2023-01-01' AND '2023-12-31';
From a high level, in order to execute this statement the database will filter for the rows that we need, grab the data we need from those rows, and return the unique ones. That seems simple enough for a database as long as the date column is indexed. However, the important part to consider is what the database needs to do to ensure all the data returned is unique. The database would need to keep all that data in memory someplace and use CPU time to sort these columns then remove the duplicates. Without the inclusion of a unique index, the sort will take time because there&rsquo;s no guarantee that each column is unique."></head><body class=terminal><div class=container><div class=terminal-nav><header class=terminal-logo><div class="logo terminal-prompt"><a href=//www.icepicky.com/ class=no-style>Jose Ibarra
</a>:~#
<a href=//www.icepicky.com/blog>blog</a>
/
<a href=//www.icepicky.com/blog/til-sql-distinct-efficiency>til-sql-distinct-efficiency</a>
/</div></header><nav class=terminal-menu><ul vocab="https://schema.org/" typeof="BreadcrumbList"><li property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" href=//www.icepicky.com/resume/><span property="name">resume/</span></a>
<meta property="position" content="1"></li><li property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" href=//www.icepicky.com/projects/><span property="name">projects/</span></a>
<meta property="position" content="2"></li><li property="itemListElement" typeof="ListItem"><a property="item" typeof="WebPage" href=//www.icepicky.com/blog/><span property="name">blog/</span></a>
<meta property="position" content="3"></li></ul></nav></div></div><div class=container><h1>TIL: SQL DISTINCT Efficiency</h1><p>Today I learned that <code>DISTINCT</code> statements can cause efficiency problems.</p><p>I was looking at some code that made a few joins across tables and used distinct for the column names. The query was causing high CPU load and it wasn&rsquo;t immediately obvious from first glance why that was happening. You could imagine the query looked like this (with a few more joins and selects):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>DISTINCT</span> transactions.date, transactions.total_amount, transaction_items.amount, transaction_items.name
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> transactions
</span></span><span style=display:flex><span><span style=color:#66d9ef>INNER</span> <span style=color:#66d9ef>JOIN</span> transaction_items <span style=color:#66d9ef>ON</span> transaction_items.transaction_id <span style=color:#f92672>=</span> transactions.id
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span> transactions.date <span style=color:#66d9ef>BETWEEN</span> <span style=color:#e6db74>&#39;2023-01-01&#39;</span> <span style=color:#66d9ef>AND</span> <span style=color:#e6db74>&#39;2023-12-31&#39;</span>;
</span></span></code></pre></div><p>From a high level, in order to execute this statement the database will filter for the rows that we need, grab the data we need from those rows, and return the unique ones. That seems simple enough for a database as long as the <code>date</code> column is indexed. However, the important part to consider is what the database needs to do to ensure all the data returned is unique. The database would need to keep all that data in memory someplace and use CPU time to sort these columns then remove the duplicates. Without the inclusion of a unique index, the sort will take time because there&rsquo;s no guarantee that each column is unique.</p><p>At first glance, the SQL statement seems harmless because everything looks like it will be obviously unique at baseline - we&rsquo;re joining against IDs so it must all be unique. However, the database likely won&rsquo;t figure that out and will fall back to doing the more computationally intensive thing of sorting and removing duplicates.</p><p>The better thing for this particular query is to remove the <code>DISTINCT</code> altogether. This code may be buggy to begin with because there could be transactions on the same date with the same total amount, etc. Besides the bug, the <code>DISTINCT</code> is unnecessary because the results should be unique because we&rsquo;re joining on unique IDs.</p><p>If the <code>DISTINCT</code> had to stay, it may be better to also select primary IDs so that the database could ensure that certain fields are guaranteed to be unique - that way it doesn&rsquo;t have to spend time sorting the results.</p><div class=footer>2018-2025 Jose Ibarra</div></div></body></html>