<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    
      <title>Jose Ibarra &middot; Til</title>
    

    
      
        <meta name="description" content="Jose Ibarra is a staff software engineer at Gusto and MCS and BS Computer Science graduate from Arizona State University.">
        <meta property="og:description" content="Jose Ibarra is a staff software engineer at Gusto and MCS and BS Computer Science graduate from Arizona State University." />
      
    

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="all,follow">
    <meta name="referrer" content="always" />
    <meta name="googlebot" content="index,follow,snippet,archive">
    <link rel="stylesheet" href="//www.icepicky.com/hugo-theme-console/css/terminal-0.7.4.min.css">
    <link rel="stylesheet" href="//www.icepicky.com/hugo-theme-console/css/animate-4.1.1.min.css">
    <link rel="stylesheet" href="//www.icepicky.com/hugo-theme-console/css/console.css">
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->   
      <link href="//www.icepicky.com/tags/til/index.xml" rel="alternate" type="application/rss+xml" title="Jose Ibarra" />
    <meta property="og:title" content="Til" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="//www.icepicky.com/tags/til/" />


<meta name="twitter:title" content="Til"/>
<meta name="twitter:description" content="Jose Ibarra is a staff software engineer at Gusto and MCS and BS Computer Science graduate from Arizona State University."/>

</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
          <header class="terminal-logo">
            <div class="logo terminal-prompt">
              
              
              <a href="//www.icepicky.com/" class="no-style ">
                Jose Ibarra
              </a>
              :~#
              
                
                  <a href='//www.icepicky.com/tags'>tags</a>
                  /
                  
                
              
                
                  <a href='//www.icepicky.com/tags/til'>til</a>
                  /
                  
                
              
                
              
            </div>
          </header>
          <nav class="terminal-menu">
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                <li property="itemListElement" typeof="ListItem">
                    <a property="item" typeof="WebPage" href="//www.icepicky.com/resume/">
                    <span property="name">resume/</span></a>
                    <meta property="position" content="1" />
                </li>
                
                <li property="itemListElement" typeof="ListItem">
                    <a property="item" typeof="WebPage" href="//www.icepicky.com/projects/">
                    <span property="name">projects/</span></a>
                    <meta property="position" content="2" />
                </li>
                
                <li property="itemListElement" typeof="ListItem">
                    <a property="item" typeof="WebPage" href="//www.icepicky.com/blog/">
                    <span property="name">blog/</span></a>
                    <meta property="position" content="3" />
                </li>
                
            </ul>
          </nav>
        </div>
    </div>

    <div class="container " >
        
<h1>Til</h1>
<br/>


<div class="posts-list">

    
        <div class="post">
            <p>
                <div class="date">Nov. 8, 2023</div>
                <h1><a href="//www.icepicky.com/blog/til-git-force-with-lease/" title="TIL: Git Force With Lease">TIL: Git Force With Lease</a></h1>
                <p>Today I learned about <a href="https://git-scm.com/docs/git-push#Documentation/git-push.txt---force-with-leaseltrefnamegt" target="_blank" rel="noopener">the Git <code>--force-with-lease</code> command</a> .</p>
<p>I&rsquo;ll restate a description of the command but it allows you to rebase and force push with less risks than using <code>--force</code>. If you had pushed your changes up to a remote branch and somebody else had pushed up new changes to that remote branch while you&rsquo;re rebasing. After you finish rebasing, a normal <code>git push</code> will fail because the local refs don&rsquo;t match the remote ones. Usually people will <code>git push --force</code> at this point because they were just rebasing their branch. However, this would wipe away commits on the remote branch. This is easy to do if you&rsquo;re working on a branch and don&rsquo;t realize that somebody else had commit to it.</p>
            </p>
        </div>
    

    
        <div class="post">
            <p>
                <div class="date">Nov. 7, 2023</div>
                <h1><a href="//www.icepicky.com/blog/til-sql-distinct-efficiency/" title="TIL: SQL DISTINCT Efficiency">TIL: SQL DISTINCT Efficiency</a></h1>
                <p>Today I learned that <code>DISTINCT</code> statements can cause efficiency problems.</p>
<p>I was looking at some code that made a few joins across tables and used distinct for the column names. The query was causing high CPU load and it wasn&rsquo;t immediately obvious from first glance why that was happening. You could imagine the query looked like this (with a few more joins and selects):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">SELECT</span> <span style="color:#66d9ef">DISTINCT</span> transactions.date, transactions.total_amount, transaction_items.amount, transaction_items.name
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span> transactions
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> transaction_items <span style="color:#66d9ef">ON</span> transaction_items.transaction_id <span style="color:#f92672">=</span> transactions.id
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">WHERE</span> transactions.date <span style="color:#66d9ef">BETWEEN</span> <span style="color:#e6db74">&#39;2023-01-01&#39;</span> <span style="color:#66d9ef">AND</span> <span style="color:#e6db74">&#39;2023-12-31&#39;</span>;
</span></span></code></pre></div><p>From a high level, in order to execute this statement the database will filter for the rows that we need, grab the data we need from those rows, and return the unique ones. That seems simple enough for a database as long as the <code>date</code> column is indexed. However, the important part to consider is what the database needs to do to ensure all the data returned is unique. The database would need to keep all that data in memory someplace and use CPU time to sort these columns then remove the duplicates. Without the inclusion of a unique index, the sort will take time because there&rsquo;s no guarantee that each column is unique.</p>
            </p>
        </div>
    

    
        <div class="post">
            <p>
                <div class="date">Aug. 21, 2023</div>
                <h1><a href="//www.icepicky.com/blog/til-mysql-transaction-isolation-levels/" title="TIL: MySQL Transaction Isolation Levels">TIL: MySQL Transaction Isolation Levels</a></h1>
                <p>Today I learned about MySQL transaction isolation levels.</p>
<p>I was trying to debug issues where concurrent processes didn&rsquo;t seem to be locking rows in the database correctly. A simplified version of the offending code could look something like this (comments added for those unfamiliar with Rails):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#75715e"># Reader: Assume the record we&#39;re processing is not processed</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Query for the row with ID 123 for table some_active_record_classes</span>
</span></span><span style="display:flex;"><span>some_active_record_class <span style="color:#f92672">=</span> <span style="color:#66d9ef">SomeActiveRecordClass</span><span style="color:#f92672">.</span>where(id: <span style="color:#ae81ff">123</span>)<span style="color:#f92672">.</span>first
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ActiveRecord</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Base</span><span style="color:#f92672">.</span>transaction <span style="color:#66d9ef">do</span> <span style="color:#75715e"># Open a database transaction</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Query for associated data from another table processed_items</span>
</span></span><span style="display:flex;"><span>  processed_items <span style="color:#f92672">=</span> <span style="color:#66d9ef">ProcessedItem</span><span style="color:#f92672">.</span>where(<span style="color:#e6db74">foreign_key</span>: some_active_record_class<span style="color:#f92672">.</span>id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Lock the row with ID 123</span>
</span></span><span style="display:flex;"><span>  some_active_record_class<span style="color:#f92672">.</span>lock!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Requery the database for ID 123 to ensure we have the most up to date data after locking</span>
</span></span><span style="display:flex;"><span>  some_active_record_class<span style="color:#f92672">.</span>reload!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Early exit if the record is processed</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">if</span> some_active_record_class<span style="color:#f92672">.</span>processed <span style="color:#f92672">==</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Simulate long running logic by waiting for 5 seconds</span>
</span></span><span style="display:flex;"><span>  sleep(<span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Update the DB </span>
</span></span><span style="display:flex;"><span>  some_active_record_class<span style="color:#f92672">.</span>update!(<span style="color:#e6db74">processed</span>: <span style="color:#66d9ef">true</span>, <span style="color:#e6db74">processed_count</span>: processed_items<span style="color:#f92672">.</span>size)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span> <span style="color:#75715e"># Release the lock, commit, and close the transaction</span>
</span></span></code></pre></div><p>When running that code concurrently, you&rsquo;d expect that only one process would do the updates and the other process(es) would exit immediately after grabbing the lock. However, we were seeing that all processes would update the database. Originally we thought the problem was that we weren&rsquo;t opening a lock at all or we weren&rsquo;t opening the lock correctly. We were correct on one point of the hypothesis: we were opening a lock but the logic to open it was incorrect.</p>
            </p>
        </div>
    

</div>


        <div class="footer">2018-2025 Jose Ibarra</div>

    </div>
  </body>
</html>
